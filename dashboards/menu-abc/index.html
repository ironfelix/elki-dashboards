<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABC-анализ iiko: управленческий отчет</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f3f3f1;
      --panel: #fbfbfa;
      --ink: #171717;
      --muted: #6a6a6a;
      --line: #d9d9d6;
      --line-strong: #b8b8b4;
      --a: #1f1f1f;
      --b: #555;
      --c: #969693;
      --ok: #2e2e2e;
      --warn: #575757;
      --risk: #7d7d7a;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 0% 0%, #ffffff 0%, #f4f4f2 35%),
        linear-gradient(180deg, #f8f8f6 0%, #f1f1ef 100%);
      min-height: 100vh;
    }

    .app {
      max-width: 1320px;
      margin: 0 auto;
      padding: 22px 16px 30px;
    }

    .top {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: clamp(24px, 3vw, 34px);
      letter-spacing: -0.02em;
    }

    .sub {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }

    .btn {
      border: 1px solid var(--line-strong);
      border-radius: 999px;
      background: #fff;
      color: var(--ink);
      padding: 8px 13px;
      font: inherit;
      font-size: 13px;
      cursor: pointer;
    }

    .btn:hover { background: #fefefe; }

    .card {
      background: rgba(251, 251, 250, 0.92);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 13px;
    }

    .goal {
      margin-bottom: 10px;
      display: grid;
      gap: 6px;
    }

    .label {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
    }

    .goal strong { font-size: 16px; font-weight: 600; }

    .tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin-bottom: 10px;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 7px 11px;
      white-space: nowrap;
      font-size: 13px;
      cursor: pointer;
      color: #2f2f2f;
    }

    .tab.active {
      background: #151515;
      color: #fff;
      border-color: #151515;
    }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    select, input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      padding: 9px 10px;
      font: inherit;
      font-size: 13px;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(5, minmax(150px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .kpi-name { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi-value { font-size: 23px; line-height: 1.1; font-weight: 700; margin-bottom: 4px; }
    .kpi-foot { font-size: 12px; color: var(--muted); }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .decision-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 8px;
    }

    .decision-col {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }

    .decision-col h4 {
      margin: 0 0 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
    }

    .decision-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .decision-list li { line-height: 1.35; }

    .no-sales {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 6px;
      font-size: 13px;
      max-height: 220px;
      overflow: auto;
    }

    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }

    table {
      width: 100%;
      min-width: 1080px;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      font-size: 13px;
    }

    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ededea;
      vertical-align: middle;
    }

    th {
      position: sticky;
      top: 0;
      background: #f8f8f6;
      z-index: 1;
      font-weight: 600;
    }

    tbody tr:last-child td { border-bottom: none; }

    .mono { font-variant-numeric: tabular-nums; }

    .abc {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 2px 7px;
      display: inline-block;
      min-width: 24px;
      text-align: center;
      font-weight: 600;
    }

    .abc-a { background: #ececec; }
    .abc-b { background: #f3f3f3; }
    .abc-c { background: #f1f1ef; color: #555; }

    .trend-up { color: var(--ok); }
    .trend-down { color: var(--risk); }
    .trend-flat { color: var(--warn); }

    .decision {
      font-size: 11px;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 3px 8px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: .05em;
      font-weight: 600;
    }

    .d-keep { background: #ececec; }
    .d-rework { background: #f2f2f2; }
    .d-test { background: #f3f3f1; color: #474747; }
    .d-remove { background: #e6e6e4; color: #252525; }

    .footer {
      margin-top: 9px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 1080px) {
      .kpis { grid-template-columns: repeat(3, minmax(150px, 1fr)); }
      .grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 720px) {
      .top { grid-template-columns: 1fr; }
      .toolbar { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .decision-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 500px) {
      .kpis { grid-template-columns: 1fr; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="top">
      <div>
        <h1>ABC-анализ iiko: управленческий отчет</h1>
        <p class="sub" id="metaLine">Загрузка реальных данных...</p>
      </div>
      <button class="btn" id="reloadBtn" type="button">Обновить отображение</button>
    </section>

    <section class="card goal">
      <span class="label">Фокус</span>
      <strong>Не просто смотреть ABC-классы, а сразу видеть управленческие действия: что защищать, что дорабатывать, что тестово выводить.</strong>
    </section>

    <div class="tabs" id="locationTabs"></div>

    <section class="toolbar">
      <select id="periodSelect"></select>
      <select id="decisionFilter">
        <option value="all">Все решения</option>
        <option value="keep">Только защитить</option>
        <option value="rework">Только доработать</option>
        <option value="test">Только тест</option>
        <option value="remove">Только выводить</option>
      </select>
      <input id="searchInput" type="text" placeholder="Поиск по блюду или группе" />
    </section>

    <section class="kpis" id="kpiGrid"></section>

    <section class="grid">
      <article class="card">
        <h2 class="section-title">Ключевые управленческие решения</h2>
        <div class="decision-grid">
          <div class="decision-col">
            <h4>Защитить</h4>
            <ul class="decision-list" id="keepList"></ul>
          </div>
          <div class="decision-col">
            <h4>Доработать</h4>
            <ul class="decision-list" id="reworkList"></ul>
          </div>
          <div class="decision-col">
            <h4>Тест / Вывод</h4>
            <ul class="decision-list" id="removeList"></ul>
          </div>
        </div>
      </article>

      <article class="card">
        <h2 class="section-title">Нет продаж в текущем периоде</h2>
        <ul class="no-sales" id="noSalesList"></ul>
      </article>
    </section>

    <section class="card">
      <h2 class="section-title">Детализация позиций</h2>
      <div class="sub" id="dataCoverageNote" style="margin-bottom:8px"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:18%">Блюдо</th>
              <th style="width:12%">Группа</th>
              <th style="width:7%">Q</th>
              <th style="width:7%">R</th>
              <th style="width:7%">P</th>
              <th style="width:10%">Тренд R/P</th>
              <th style="width:8%">Фудкост</th>
              <th style="width:10%">Себестоим., ₽</th>
              <th style="width:10%">Оценка выручки, ₽</th>
              <th style="width:8%">Решение</th>
              <th style="width:23%">Комментарий</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <div class="footer">Источник: реальная выгрузка iiko ABC (`ABC.xlsx`). Если для точки нет сумм, это ограничение структуры выгрузки (доступны ABC-классы, но не абсолютная выручка).</div>
  </div>

  <script>
    const SCORE = { A: 3, B: 2, C: 1, null: 0, undefined: 0 };

    const state = {
      data: null,
      locationIdx: 0,
      periodIdx: 0,
      filter: "all",
      search: "",
    };

    function fmtInt(v) {
      return new Intl.NumberFormat("ru-RU").format(Math.round(v));
    }

    function fmtMoney(v) {
      if (v === null || v === undefined || Number.isNaN(v)) return "—";
      return new Intl.NumberFormat("ru-RU").format(Math.round(v)) + " ₽";
    }

    function fmtPct(v) {
      if (v === null || v === undefined || Number.isNaN(v)) return "—";
      return (v * 100).toFixed(1).replace(".", ",") + "%";
    }

    function abcBadge(v) {
      if (!v) return "<span class='abc'>—</span>";
      return `<span class="abc abc-${v.toLowerCase()}">${v}</span>`;
    }

    function trendSymbol(delta) {
      if (delta > 0) return `<span class="trend-up">↑ ${delta}</span>`;
      if (delta < 0) return `<span class="trend-down">↓ ${Math.abs(delta)}</span>`;
      return `<span class="trend-flat">→ 0</span>`;
    }

    function decisionLabel(action) {
      if (action === "keep") return "Защитить";
      if (action === "rework") return "Доработать";
      if (action === "test") return "Тест";
      return "Выводить";
    }

    function decisionClass(action) {
      if (action === "keep") return "d-keep";
      if (action === "rework") return "d-rework";
      if (action === "test") return "d-test";
      return "d-remove";
    }

    async function loadData() {
      const urls = ["./abc_data.json", "./dashboards/menu-abc/abc_data.json"];
      for (const url of urls) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (res.ok) return await res.json();
        } catch (_) {}
      }
      throw new Error("Не удалось загрузить abc_data.json");
    }

    function enrichRows(location, periodIdx) {
      const cur = location.blocks[periodIdx];
      const prev = periodIdx > 0 ? location.blocks[periodIdx - 1] : null;
      const prevMap = new Map((prev ? prev.items : []).map(i => [i.name, i]));

      const rows = cur.items.map(item => {
        const prevItem = prevMap.get(item.name);
        const q = SCORE[item.abc_qty];
        const r = SCORE[item.abc_revenue];
        const p = SCORE[item.abc_profit];
        const prevR = prevItem ? SCORE[prevItem.abc_revenue] : 0;
        const prevP = prevItem ? SCORE[prevItem.abc_profit] : 0;
        const deltaR = r - prevR;
        const deltaP = p - prevP;

        const estRevenue = item.foodcost && item.cost_total ? item.cost_total / item.foodcost : null;

        let action = "test";
        let reason = "Нужен контроль динамики по периодам.";

        if (r >= 2 && p >= 2 && q >= 2 && !(deltaR < 0 && deltaP < 0)) {
          action = "keep";
          reason = "Сильная позиция: стабильна по выручке и прибыли.";
        } else if (r >= 2 && p === 1) {
          action = "rework";
          reason = "Хороший спрос, но слабая прибыльность: пересобрать фудкост/цену.";
        } else if (r === 1 && p === 1 && q === 1 && deltaR <= 0 && deltaP <= 0) {
          action = "remove";
          reason = "Стабильно слабая позиция по всем ABC-метрикам.";
        } else if (deltaR < 0 && deltaP < 0) {
          action = "test";
          reason = "Негативный тренд: запустить тест/ограниченный вывод.";
        } else if (r === 1 && p <= 2) {
          action = "test";
          reason = "Низкая выручка: проверить роль в меню и канал продаж.";
        }

        const scoreSum = q + r + p;

        return {
          ...item,
          deltaR,
          deltaP,
          action,
          reason,
          scoreSum,
          estRevenue,
        };
      });

      const curSet = new Set(cur.items.map(i => i.name));
      const noSales = (prev ? prev.items : []).filter(i => !curSet.has(i.name));

      return { rows, noSales, cur, prev };
    }

    function renderTabs() {
      const tabs = document.getElementById("locationTabs");
      tabs.innerHTML = state.data.locations.map((loc, idx) =>
        `<button class="tab ${idx === state.locationIdx ? "active" : ""}" data-idx="${idx}" type="button">${loc.name}</button>`
      ).join("");

      tabs.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => {
          state.locationIdx = Number(btn.dataset.idx);
          state.periodIdx = state.data.locations[state.locationIdx].blocks.length - 1;
          render();
        });
      });
    }

    function renderPeriodSelect() {
      const location = state.data.locations[state.locationIdx];
      const select = document.getElementById("periodSelect");
      select.innerHTML = location.blocks.map((b, idx) =>
        `<option value="${idx}" ${idx === state.periodIdx ? "selected" : ""}>${b.period}</option>`
      ).join("");

      select.onchange = () => {
        state.periodIdx = Number(select.value);
        render();
      };
    }

    function render() {
      const location = state.data.locations[state.locationIdx];
      if (state.periodIdx >= location.blocks.length) state.periodIdx = location.blocks.length - 1;

      renderTabs();
      renderPeriodSelect();

      const { rows, noSales, cur } = enrichRows(location, state.periodIdx);
      const total = rows.length;
      const core = rows.filter(r => r.action === "keep").length;
      const rework = rows.filter(r => r.action === "rework").length;
      const remove = rows.filter(r => r.action === "remove").length;
      const risk = rows.filter(r => r.abc_revenue === "C" && r.abc_profit === "C").length;

      const hasNumbers = rows.some(r => r.foodcost !== null || r.cost_total !== null || r.estRevenue !== null);
      document.getElementById("dataCoverageNote").textContent = hasNumbers
        ? "Для этой точки доступны фудкост/себестоимость, показана расчетная оценка выручки."
        : "Для этой точки в выгрузке есть только ABC-классы (без абсолютной выручки и прибыли).";

      document.getElementById("metaLine").textContent =
        `${location.name} • ${cur.period} • позиций: ${fmtInt(total)}`;

      document.getElementById("kpiGrid").innerHTML = [
        { n: "Позиции в периоде", v: fmtInt(total), f: "в текущем срезе" },
        { n: "Защитить", v: fmtInt(core), f: "стабильное ядро" },
        { n: "Доработать", v: fmtInt(rework), f: "спрос есть, прибыль проседает" },
        { n: "Выводить", v: fmtInt(remove), f: "кандидаты на вывод" },
        { n: "Зона риска C/C", v: fmtInt(risk), f: "выручка и прибыль в C" },
      ].map(k => `
        <article class="card">
          <div class="kpi-name">${k.n}</div>
          <div class="kpi-value">${k.v}</div>
          <div class="kpi-foot">${k.f}</div>
        </article>
      `).join("");

      const keepTop = rows.filter(r => r.action === "keep").sort((a,b)=>b.scoreSum-a.scoreSum).slice(0,7);
      const reworkTop = rows.filter(r => r.action === "rework").sort((a,b)=>SCORE[b.abc_revenue]-SCORE[a.abc_revenue]).slice(0,7);
      const removeTop = rows.filter(r => r.action === "remove" || r.action === "test").sort((a,b)=>a.scoreSum-b.scoreSum).slice(0,7);

      const fillList = (id, items, formatter) => {
        const el = document.getElementById(id);
        if (!items.length) {
          el.innerHTML = "<li>Нет позиций в этой категории.</li>";
          return;
        }
        el.innerHTML = items.map(formatter).join("");
      };

      fillList("keepList", keepTop, r => `<li>${r.name} (${r.abc_revenue}/${r.abc_profit})</li>`);
      fillList("reworkList", reworkTop, r => `<li>${r.name} (${r.abc_revenue}/${r.abc_profit})</li>`);
      fillList("removeList", removeTop, r => `<li>${r.name} (${decisionLabel(r.action)})</li>`);

      const ns = document.getElementById("noSalesList");
      if (!noSales.length) {
        ns.innerHTML = "<li>Относительно предыдущего периода выпадений нет.</li>";
      } else {
        ns.innerHTML = noSales.slice(0, 40).map(i =>
          `<li>${i.name} <span class="sub">(${i.abc_revenue || "—"}/${i.abc_profit || "—"} в прошлом периоде)</span></li>`
        ).join("");
      }

      const filtered = rows.filter(r => {
        if (state.filter !== "all" && r.action !== state.filter) return false;
        if (state.search) {
          const q = state.search.toLowerCase();
          const text = `${r.name} ${r.group}`.toLowerCase();
          if (!text.includes(q)) return false;
        }
        return true;
      }).sort((a,b)=> (SCORE[b.abc_revenue]-SCORE[a.abc_revenue]) || (SCORE[b.abc_profit]-SCORE[a.abc_profit]));

      document.getElementById("tableBody").innerHTML = filtered.map(r => `
        <tr>
          <td>${r.name}</td>
          <td>${r.group || "—"}</td>
          <td>${abcBadge(r.abc_qty)}</td>
          <td>${abcBadge(r.abc_revenue)}</td>
          <td>${abcBadge(r.abc_profit)}</td>
          <td class="mono">${trendSymbol(r.deltaR)} / ${trendSymbol(r.deltaP)}</td>
          <td class="mono">${fmtPct(r.foodcost)}</td>
          <td class="mono">${fmtMoney(r.cost_total)}</td>
          <td class="mono">${fmtMoney(r.estRevenue)}</td>
          <td><span class="decision ${decisionClass(r.action)}">${decisionLabel(r.action)}</span></td>
          <td>${r.reason}</td>
        </tr>
      `).join("");
    }

    async function init() {
      try {
        state.data = await loadData();
        state.locationIdx = 0;
        state.periodIdx = state.data.locations[0].blocks.length - 1;

        document.getElementById("decisionFilter").addEventListener("change", (e) => {
          state.filter = e.target.value;
          render();
        });

        document.getElementById("searchInput").addEventListener("input", (e) => {
          state.search = e.target.value.trim();
          render();
        });

        document.getElementById("reloadBtn").addEventListener("click", () => render());

        render();
      } catch (err) {
        document.getElementById("metaLine").textContent =
          `Ошибка загрузки данных: ${err.message}. Для локального просмотра запустите сервер: python3 -m http.server`;
      }
    }

    init();
  </script>
</body>
</html>
